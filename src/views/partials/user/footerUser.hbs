<!-- ****************** Required JS - DASHBOARD ****************** -->
<script src="../vendor/js/Chart.bundle.min.js"></script>
<script src="../vendor/js/owl.carousel.js"></script>

{{> modals/modalAcuerdoConfidencial}}

{{#if jsonDim_empresa}}
{{> user/pieCharts}}
{{/if}}

<script>
	function acuerdoChecked() {
		// Acción al aceptar el acuerdo de confidencialidad
		const acuerdoCheck = document.getElementById('acuerdo-check').checked
		console.log("Acuerdo Check: " + acuerdoCheck)
		if (acuerdoCheck) {
			console.log("Acuerdo aceptado, serás redireccionado..")
			fetch('/acuerdo-de-confidencialidad', {
				method: 'POST',
				body: JSON.stringify({estado:2}),
				headers: {'Content-Type': 'application/json'}
			}).then(res => res.json())
				.catch(error => console.error('Error:', error))
				.then(response => {
					console.log("RESPUESTA DE ACUERDO CHECK CONTROLLER >> ", response)
					if (response.ok){
						window.location.href = response.txt
					} else {
						Swal.fire(
							'Error!',
							'Ocurrió algo inesperado al aceptar el acuerdo de confidencialidad',
							'error'
						)
					}
				});
		}
	}

	function msgSinConsultor() {
		Swal.fire(
			'Atención',
			'Tu consultor no ha sido asignado. Recibiras una notificación a tu correo y podras ingresar',
			'info'
		)
	}

	{{#if archivos}}
	function cargarArchivos_Empresa(tabla, idArchivo) {
		const idEmpresa = document.getElementById("idEmpresa").value;
		const inputArchivo = document.getElementById("inputArchivo"+idArchivo);
		if (inputArchivo) {
			const estado = document.getElementById("spanEstado"+idArchivo);
			const btnArchivo = document.getElementById("btnVer"+idArchivo);
			inputArchivo.addEventListener('change', (e) => {
				const file = e.target.files[0]
				console.log(file)
				let ruta = '/guardar-archivos-analisis', etapa = 2
				if (tabla == 'archivos_empresarial') { etapa= 3; ruta = '/guardar-archivos-empresariales' }
				else if (tabla == 'archivos_estrategico') { etapa = 4; ruta = '/guardar-archivos-estrategico' }

				const formData = new FormData();
				formData.append('id', idArchivo);
				formData.append('empresa', idEmpresa);
				formData.append('file', file);
				formData.append('etapa', etapa);
				formData.append('tabla', tabla);

				fetch(ruta, {
					method: 'POST',
					body: formData,
				})
					.then(res => res.json())
					.catch(error => console.error('Error:', error))
					.then(response => {
						if (response.ok) {
							toastr.success("El archivo ha sido cargado exitosamente", "Atención", {
								positionClass: "toast-top-center",
								timeOut: 5e3,
								closeButton: !0,
								debug: !1,
								newestOnTop: !0,
								progressBar: !0,
								preventDuplicates: !0,
								onclick: null,
								showDuration: "300",
								hideDuration: "1000",
								extendedTimeOut: "1000",
								showEasing: "swing",
								hideEasing: "linear",
								showMethod: "fadeIn",
								hideMethod: "fadeOut",
								tapToDismiss: !1
							})

							btnArchivo.style.display = 'block'
							btnArchivo.href = response.url
							estado.classList.remove("badge-warning")
							estado.classList.add("badge-success")
							estado.innerHTML = "Cargado"
							
						} else {
							toastr.warning("No sé pudo subir el archivo, contacte a soporte", "Error", {
								positionClass: "toast-top-center",
								timeOut: 5e3,
								closeButton: !0,
								debug: !1,
								newestOnTop: !0,
								progressBar: !0,
								preventDuplicates: !0,
								onclick: null,
								showDuration: "300",
								hideDuration: "1000",
								extendedTimeOut: "1000",
								showEasing: "swing",
								hideEasing: "linear",
								showMethod: "fadeIn",
								hideMethod: "fadeOut",
								tapToDismiss: !1
							})
						}
					});
			});
		}
	}
	{{/if}}

    (function ($) {

        const dzGraficasEmpresa = function (indicadores) {
			const coloresDim = ['#812082', '#f2f2f2'];
			const opciones = {
				legend: false,
				scales: {
					yAxes: [{
						gridLines: {
							display: true
						},
						ticks: {
							beginAtZero: true,
							min: 0, // minimum value
							max: 10 // maximum value
						}
					}],
					xAxes: [{
						gridLines: {
							display: false
						},
						ticks: {
							fontSize: 10
						},
						//barPercentage: 0.5,
						//categoryPercentage: 1,
						//barThickness: 14,
						//maxBarThickness: 10,
						barPercentage: 4,
						categoryPercentage: 4,
						barThickness: 28,
						maxBarThickness: 25,
					}]
				}
			}
            /** GRÁFICA PARA INDICADORES */
			const chartIndicadores1 = (indicadores, nuevosProyectos) => {
				let dataAreasVitales1 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
				let dataPE1 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                let dataAreasVitales2 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
				let dataPE2 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
				
				// PERCEPCIÓN CLIENTE
                const areasVitales = indicadores.areasVitales1
                dataAreasVitales1 = [areasVitales.producto, areasVitales.administracion, areasVitales.talento_humano, areasVitales.finanzas, areasVitales.servicio_cliente, areasVitales.operaciones, areasVitales.ambiente_laboral, areasVitales.innovacion, areasVitales.marketing, areasVitales.ventas]

				if (indicadores.areasVitales2) {
					const areasVitales = indicadores.areasVitales2
                	dataAreasVitales2 = [areasVitales.producto, areasVitales.administracion, areasVitales.talento_humano, areasVitales.finanzas, areasVitales.servicio_cliente, areasVitales.operaciones, areasVitales.ambiente_laboral, areasVitales.innovacion, areasVitales.marketing, areasVitales.ventas]
				}

				// PERCEPCIÓN ESTADÍSTICA
				if (indicadores.pe_Areas1) {
					const pe_Areas = indicadores.pe_Areas1
					dataPE1 = [pe_Areas.producto, pe_Areas.administracion, pe_Areas.talento_humano, pe_Areas.finanzas, pe_Areas.servicio_cliente, pe_Areas.operaciones, pe_Areas.ambiente_laboral, pe_Areas.innovacion, pe_Areas.marketing, pe_Areas.ventas]
				}
				if (indicadores.pe_Areas2) {
					const pe_Areas = indicadores.pe_Areas2
					dataPE2 = [pe_Areas.producto, pe_Areas.administracion, pe_Areas.talento_humano, pe_Areas.finanzas, pe_Areas.servicio_cliente, pe_Areas.operaciones, pe_Areas.ambiente_laboral, pe_Areas.innovacion, pe_Areas.marketing, pe_Areas.ventas]
				}

                if (nuevosProyectos == 1) {
                    opciones.scales.yAxes[0].ticks.max = 5;
                }

				// GRAFICA FECHA INICIO
				if ($('#chartEmpresa_areas1').length > 0) {
					const chartEmpresa = document.getElementById("chartEmpresa_areas1").getContext('2d')

					chartEmpresa.height = 100;
					new Chart(chartEmpresa, {
						type: 'bar',
						data: {
							defaultFontFamily: 'Oblivian',
							labels: ["Producto", "Admin", "Talento Humano", "Finanzas", "S. Al cliente", "Operaciones", "A. Laboral", "Innovación", "Marketing", "Ventas"],
							datasets: [
								// PERCEPCIÓN CLIENTE
								{
									label: 'Valor',
									backgroundColor: "#50368C",
									borderColor: "#50368C",
									data: dataAreasVitales1,
									fill: false,
								},
								// PERCEPCIÓN ESTADÍSTICA
								{
									label: "Valor",
									fill: false,
									backgroundColor: "#FED061",
									borderColor: "#FED061",
									data: dataPE1,
								}
							]
						},
						options: opciones
					});
				}

				// GRAFICA FECHA FINAL
				if ($('#chartEmpresa_areas2').length > 0) {
					const chartEmpresa = document.getElementById("chartEmpresa_areas2").getContext('2d')

					chartEmpresa.height = 100;
					new Chart(chartEmpresa, {
						type: 'bar',
						data: {
							defaultFontFamily: 'Oblivian',
							labels: ["Producto", "Admin", "Talento Humano", "Finanzas", "S. Al cliente", "Operaciones", "A. Laboral", "Innovación", "Marketing", "Ventas"],
							datasets: [
								// PERCEPCIÓN CLIENTE
								{
									label: 'Valor',
									backgroundColor: "#50368C",
									borderColor: "#50368C",
									data: dataAreasVitales2,
									fill: false,
								},
								// PERCEPCIÓN ESTADÍSTICA
								{
									label: "Valor",
									fill: false,
									backgroundColor: "#FED061",
									borderColor: "#FED061",
									data: dataPE2,
								}
							]
						},
						options: opciones
					});
				}

			}

			const chartIndicadores2 = (indicadores, nuevosProyectos) => {
				let chartPE_cliente = [0, 0, 0, 0]
                let chartPE_estadistica = [0, 0, 0, 0]
				let chartPE_cliente2 = [0, 0, 0, 0]
                let chartPE_estadistica2 = [0, 0, 0, 0]
                let titulos = ["Producto", "Administración", "Operaciones", "Marketing"];

                const pe_cliente = indicadores.dimensiones1
				chartPE_cliente = [pe_cliente.producto, pe_cliente.administracion, pe_cliente.operaciones, pe_cliente.marketing]
				if (indicadores.dimensiones2) {
					const pe_cliente = indicadores.dimensiones2
					chartPE_cliente2 = [pe_cliente.producto, pe_cliente.administracion, pe_cliente.operaciones, pe_cliente.marketing]
				}

				// PERCEPCIÓN ESTADÍSTICA
				if (indicadores.pe_Dimensiones1) {
					const pe_estadistica = indicadores.pe_Dimensiones1
					chartPE_estadistica = [pe_estadistica.producto, pe_estadistica.administracion, pe_estadistica.operaciones, pe_estadistica.marketing]
				}
				if (indicadores.pe_Dimensiones2) {
					const pe_estadistica = indicadores.pe_Dimensiones2
					chartPE_estadistica2 = [pe_estadistica.producto, pe_estadistica.administracion, pe_estadistica.operaciones, pe_estadistica.marketing]
				}

				if (nuevosProyectos == 1) {
					titulos = ["Experiencia en el Rubro", "Mentalidad Empresarial", "Viabilidad del Negocio", "Estructura del Negocio"]
					chartPE_cliente = [pe_cliente.experiencia_rubro, pe_cliente.mentalidad, pe_cliente.viabilidad_, pe_cliente.estructura]

					if (indicadores.dimensiones2) {
					const pe_cliente = indicadores.dimensiones2
					chartPE_cliente2 = [pe_cliente.experiencia_rubro, pe_cliente.mentalidad, pe_cliente.viabilidad_, pe_cliente.estructura]
				}
				}

				if ($('#chartEmpresa_dim1').length > 0) {
					const chartEmpresa = document.getElementById("chartEmpresa_dim1").getContext('2d')
					chartEmpresa.height = 100;
					new Chart(chartEmpresa, {
						type: 'bar',
						data: {
							defaultFontFamily: 'Oblivian',
							labels: titulos,
							datasets: [
								// PERCEPCIÓN CLIENTE
								{
									label: 'Valor',
									backgroundColor: "#50368C",
									borderColor: "#50368C",
									data: chartPE_cliente,
									fill: false,
								},
								// PERCEPCIÓN ESTADÍSTICA
								{
									label: 'Valor',
									fill: false,
									backgroundColor: "#FED061",
									borderColor: "#FED061",
									data: chartPE_estadistica,
								}
							]
						},
						options: opciones
					});
				}

				if ($('#chartEmpresa_dim2').length > 0) {
					const chartEmpresa = document.getElementById("chartEmpresa_dim2").getContext('2d')
					chartEmpresa.height = 100;
					new Chart(chartEmpresa, {
						type: 'bar',
						data: {
							defaultFontFamily: 'Oblivian',
							labels: titulos,
							datasets: [
								// PERCEPCIÓN CLIENTE
								{
									label: 'Valor',
									backgroundColor: "#50368C",
									borderColor: "#50368C",
									data: chartPE_cliente2,
									fill: false,
								},
								// PERCEPCIÓN ESTADÍSTICA
								{
									label: 'Valor',
									fill: false,
									backgroundColor: "#FED061",
									borderColor: "#FED061",
									data: chartPE_estadistica2,
								}
							]
						},
						options: opciones
					});
				}
			}

			return {
                load: function (data, empresaNueva) {
					chartIndicadores1(data, empresaNueva);
					chartIndicadores2(data, empresaNueva);
                },
            }

        }();

        jQuery(document).ready(function () {
			// PROPIEDAD PARA MODIFICAR SCROLL AL ABRIR O CERRAR EL SIDEBAR DE TAREAS
			$(".chatbox-close").on("click", () => {
                $('#cuerpoGeneral').css('overflow-y', 'auto')
			})
        });

        jQuery(window).on('load', function () {
			if (document.getElementById('jsonIndicadores')) {
				let data = document.getElementById('jsonIndicadores').value
				data = JSON.parse(data)
				const nuevosProyectos = document.getElementById('nuevosProyectos').value;
				dzGraficasEmpresa.load(data, nuevosProyectos);
			}
        });
		
	})(jQuery);

</script>